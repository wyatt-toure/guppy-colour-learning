---
title: "Analysis for 'Colour biases in learned foraging preferences in Trinidadian guppies'"
subtitle: "Experiment 1 Data Preparation and Analysis"
author: 
  - name: "M. Wyatt Toure^1^, Simon M. Reader^1^"
    affiliation: "^1^McGill University, Department of Biology, 1205 Docteur Penfield, Montreal, Quebec H3A 1B1, Canada"  
date: "Last Update: `r format(Sys.Date(), '%b %d %Y')`"
output:
  bookdown::html_document2:
    includes:
      in_header: docs/header.html
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: false
    number_sections: false
    split_by: section
    css: styles.css
    
bibliography: ["references/references.bib"]
csl: references/elife-citation-style.csl    
link-citations: yes    
        
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = 'docs/analysis-experiment-1')
  })
---

***

## Overview

This page reports the analyses for the first experiment described in 'Colour
biases in learned foraging preferences in Trinidadian guppies'. The R script to
reproduce the analysis and this site are in the
[analysis-experiment-1.Rmd](https://github.com/wyatt-toure/guppy-colour-learning-project/blob/main/analysis-experiment-1.Rmd)
file. The raw data used to conduct these analyses are available in the
[colour-learning-experiment-1-data.csv](https://github.com/wyatt-toure/guppy-colour-learning-project/blob/main/data/colour-learning-experiment-1-data.csv)
file. Note the code blocks that produce the figures and tables are not shown on
this page as they are rather long, however the code to produce the figures and
tables can also be seen in
[analysis-experiment-1.Rmd](https://github.com/wyatt-toure/guppy-colour-learning-project/blob/main/analysis-experiment-1.Rmd).
To get straight to the results go to the [Models](#models) section. To see how
to reproduce these results please visit the [How to Reproduce the
Results](https://github.com/wyatt-toure/guppy-colour-learning#how-to-reproduce-the-results)
section of the README.

***

```{r library-prep, include=FALSE}
# Loading required packages
library(lme4)
library(tidyr)
library(lmerTest)
library(ggplot2)
library(ggpubr)
library(DHARMa)
library(dplyr)
library(broom)
library(broom.mixed)
library(knitr)
library(emmeans)
library(report)
library(glmmTMB)
library(MASS)
source("R/format-p-value.R")
source("R/rename-lme4-model.R")
source("R/geom-flat-violin.R")
source("R/report-est-plus-minus-std-error.R")
source("R/report-ci.R")
```

## Data preparation 

At the time experiment 1 was conducted I (MWT) still performed much data
preparation manually in Excel so unlike in experiment 2, we do not format the
data in R for experiment 1. Additionally, several variables were created in
Excel. This Excel sheet was then exported as the `.csv` file
[colour-learning-experiment-1-data.csv](https://github.com/wyatt-toure/guppy-colour-learning-project/blob/main/data/colour-learning-experiment-1-data.csv).
All measures in
[colour-learning-experiment-1-data.csv](https://github.com/wyatt-toure/guppy-colour-learning-project/blob/main/data/colour-learning-experiment-1-data.csv)
except `ate` (denoting whether a fish ate during a trial or not) are derived
from the first 16 columns of that data sheet. Please see the [Variable
Creation](https://wyatt-toure.github.io/guppy-colour-learning/analysis-experiment-2.html#Variable_creation)
section of Experiment 2's analysis page to see how the additional measures are
derived. Variables necessary for the analysis which were not created manually
are created below. Descriptions of the variables found in the data set are given
in the Experiment 1 Metadata section of
[`metadata.md`](https://github.com/wyatt-toure/guppy-colour-learning/blob/main/data/metadata.md#experiment-1-metadata).

### Variable creation

The preference metrics `green.object.preference` and
`rewarding.object.preference` are created by subtracting the time spent near the
blue object from the time spent near the green object and subtracting the time
spent near the untrained object from the time spent near the trained object
respectively. The proportional rewarding object preference
`prop.rewarding.object.preference` is created by dividing the time spent near
the trained object by the time spent near both objects.

```{r data-prep}
# Reading in Data
my_data <- read.csv("data/colour-learning-experiment-1-data.csv")

# Creating new variables

## Green object preference
my_data <- my_data %>%
  mutate(
    green.object.preference =
      case_when(
        rewarding.object.colour == "green" ~ 
          time.with.trained.object - time.with.untrained.object,
        
        rewarding.object.colour == "blue" ~ 
          time.with.untrained.object - time.with.trained.object
      )
  )

## Rewarding object preference
my_data <- my_data %>%
  mutate(
    rewarding.object.preference =
      time.with.trained.object - time.with.untrained.object
  )

## Rewarding object proportional preference
my_data <- my_data %>%
  mutate(
    prop.rewarding.object.preference =
      (time.with.trained.object / (time.with.trained.object + time.with.untrained.object))
  )
```

### Subsetting data

We remove males from our analyses due to consistently low feeding motivation in
this particular experimental design across all males. However, we note that the
conclusions of the experiment do not change even if males are included, one can
remove the line of code below removing males from the analyses and re run the R
script and find that the statistical conclusions are maintained.

```{r remove-males}
# Removing males
my_data <- my_data %>%
  filter(
    id != "a3", id != "b3",
    id != "c3", id != "e3",
    id != "g3", id != "v3",
    id != "w3", id != "x3"
  ) %>%
  droplevels()
```

To conduct the analyses we planned, we create subsets of the full data set that
are restricted to the training trials (reinforced), the test trials
(unreinforced), and the initial test trial (unreinforced) using the `filter()`
function from `dplyr`. We change trial to a factor for the unreinforced test
trial data subset since there are two levels of trial being compared to each
other for the analysis on this data set. Trial in the training data subset is
coded as integer to allow us to look at trends in the shift of rewarding object
preference during training.

```{r data-subets}
# Restrict data to training data
training_data <- my_data %>%
  filter(trial.type == "training")

# Restrict data to only the baseline and re-test data
test_data <- my_data %>%
  filter(trial.type == "test")

# Restrict data to only the baseline data
baseline_data <- my_data %>%
  filter(trial == 0)

# Change trial to factor
test_data$trial <- as.factor(test_data$trial)
baseline_data$trial <- as.factor(baseline_data$trial)
```

### Figures directory

This script will generate figures but to store them we need to create specific
directories that have been hard coded into the script. We create the `figs/`
directory and all the subdirectories within it using the next line of code. Now
all figures that are created in this script are accessible as individual files
in the `figs/` directory. If this script is run multiple times it will return a
warning saying that the directory already exists. However, this is not
problematic since the figures are always regenerated by running the script so we
set `showWarnings` to `FALSE`.

```{r}
dir.create(file.path("figs/exp-1/residual-plots"), 
           recursive = TRUE,
           showWarnings = FALSE
           )
```

***

## Models

We analysed the data from our experiment using linear, linear mixed effect,
generalized linear mixed effect, and generalized linear models with the `lm`,
`lmer()`, `glmmTMB()`, and `glm.nb` functions from the `stats`, `lme4`,
`glmmTMB`, and `MASS` packages respectively. P-values and effective degrees of
freedom for `lme4` models were obtained using the `lmerTest` package. Model
residuals were checked they met distributional assumptions with the `DHARMa`
package, you can click the 'See Model Residuals' button below the model formulas
to see the residual diagnostic plots produced by `DHARMa` for that particular
model.

### Model 1 -  Preference for the green object at baseline

This first model contains the data for all individual guppies. I looked at the
green object preference of all guppies in an intercept only model to see if the
green object preference at baseline was significantly different from zero.
`green.object.preference` is the time spent near the green object subtracted by
the time spent near the blue object

```{r model-1, echo=TRUE}
baseline_data_model <-
  lm(green.object.preference ~ 1,
    data = baseline_data
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#BlockName"> See Model 1 Residuals </button>  
<div id="BlockName" class="collapse"> 

```{r, echo=FALSE, message=FALSE}
simulationOutput <- simulateResiduals(fittedModel = baseline_data_model)
plot(simulationOutput)

# Saving plot to figs directory
ggsave(
  filename = "exp-1-model-1-residual-plot.png",
  plot = (plot(simulationOutput)),
  path = "figs/exp-1/residual-plots/",
  device = "png",
  dpi = 300
)
```

</div>

</br>

##### Result

```{r tidying-model-1, echo=FALSE, message=FALSE}
# Setting table row names
baseline_table_row_name_vec <- c("Intercept")

# Converting data frame to tibble
tidy_baseline_model <- broom.mixed::tidy(baseline_data_model)

# Changing tibble header names
tidy_baseline_model <- rename_tidy_lme4_cols(tidy_baseline_model)

# Changing tibble row names
tidy_baseline_model[1:1, 1] <- baseline_table_row_name_vec
```

```{r,  results=TRUE, echo=FALSE}
knitr::kable(tidy_baseline_model %>%
  mutate_if(is.numeric, round, digits = 3))
```

During the initial test, there was no significant preference for the green
object across all guppies (green object preference:
`r report_est_and_std_error(tidy_baseline_model, rounding = 0)` seconds, p =
`r tidy_baseline_model$'P value' %>% round(3)`).


```{r baseline-pref-plot, echo=FALSE, message=FALSE, fig.cap="Preference for the green object relative to the blue object across all guppies at baseline. Negative values represent more time spent with the blue object, positive values indicate more time spent with the green object. Data are means +/- 95% CI", fig.id="baseline-pref-plot",  warning=FALSE, message=FALSE}
###### Baseline green object preference plot ######
baseline_data_x_axis_label <- "Initial Test"
ggplot(
  baseline_data,
  aes(
    x = trial,
    y = green.object.preference
  )
) +
  theme_minimal() +
  ylab("Green object preference (sec)") +
  xlab("") +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  geom_jitter(width = 0.04, alpha = 0.3) +
  stat_summary(
    geom = "point",
    fun = "mean",
    size = 4.5,
    shape = 15
  ) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_ci", position = position_dodge(width = 0), width = 0.1
  ) +
  scale_x_discrete(labels = baseline_data_x_axis_label)

ggsave(
  filename = "exp-1-model-1-baseline-data-plot.png",
  path = "figs/exp-1/",
  device = "png",
  dpi = 300
)
```

***

### Model 2 -  Preference for the rewarding object during training

To see whether fish were responsive during training our second model asks
whether the preference for the rewarding object changes throughout training and
whether the change in rewarding object preference is different between the
treatments.

  - **Response variable:** `rewarding.object.preference` is the time (seconds)
    spent near the rewarding object subtracted by the time spent near the
    unrewarding object
  - **Fixed effect:** `rewarding.object.colour` is the identity of the rewarding
    object (blue or green)
  - **Fixed effect:** `trial` is the number of the training trial. In this model
    it is supplied as an integer
  - **Random effect:** `id` is the identity of the individual fish

```{r model-2, echo=TRUE}
training_data_model <-
  lmer(rewarding.object.preference ~  
            rewarding.object.colour * trial + (1|id),
  data = training_data
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#BlockName2"> See Model 2 Residuals </button>  
<div id="BlockName2" class="collapse">  

```{r, echo=FALSE, message=FALSE}
# Residual diagnostics
simulationOutput <- simulateResiduals(
  fittedModel = training_data_model,
  n = 1000
)
plot(simulationOutput)

# Saving plot to figs directory
ggsave(
  filename = "exp-1-model-2-residual-plot.png",
  plot = (plot(simulationOutput)),
  path = "figs/exp-1/residual-plots/",
  device = "png",
  dpi = 300
)
```

We see that there is a slight amount of structure in the residuals, however,
visual inspection of the residuals reveals that this structure is minor. There
is not an indication of a gross model misfit so our model is still suitable.

</div>

```{r tidying-model-2, echo=FALSE, message=FALSE}
# Setting table row names
training_model_table_row_name_vec <- c(
  "Intercept",
  "Rewarding object colour",
  "Trial",
  "Rewarding object colour X Trial"
)

# Converting data frame to tibble
tidy_training_data_model <- broom.mixed::tidy(training_data_model)

# Formatting p value
tidy_training_data_model$p.value <- format_p_value(tidy_training_data_model$p.value)

# Changing tibble header names
tidy_training_data_model <- rename_tidy_lme4_cols(tidy_training_data_model)

# Changing tibble row names
tidy_training_data_model[1:4, 3] <- training_model_table_row_name_vec
```

</br>

##### Results

```{r,  results=TRUE, echo=FALSE}
knitr::kable(tidy_training_data_model[1:4, ] %>%
  dplyr::select(-group, -effect) %>%
  mutate_if(is.numeric, round, digits = 3))
```

There was a significant effect of trial. Over the 20 training trials, guppies in
the two treatments increased their relative preference for their respective
rewarded objects by
`r report_est_and_std_error(tidy_training_data_model, rounding = 0)[3]` seconds
each trial (Figure \@ref(fig:colour-pref-training-plot), p
`r tidy_training_data_model$'P value'[3]`). There was also a significant effect
of rewarded-object colour (p = `r tidy_training_data_model$'P value'[2]`).
during training green-rewarded guppies expressed a stronger preference for their
rewarded object (the green object) than did blue-rewarded guppies did for the
blue object, a difference of
`r report_est_and_std_error(tidy_training_data_model, rounding = 0)[2]` seconds.
However, there was no significant interaction effect between rewarding object
colour and trial
(`r report_est_and_std_error(tidy_training_data_model, rounding = 0)[4]`
seconds, p = `r tidy_training_data_model$'P value'[4]`), *i.e.*, the rate of
increase in object preference over trials did not significantly differ between
the treatments.

```{r colour-pref-training-plot, echo=FALSE, message=FALSE, fig.cap="Relative preference for the green object in both treatments during training trials (trials 1-20). Negative values represent more time spent with the blue object, positive values indicate more time spent with the green object. Light lines connect individuals across trials and bold lines represents a linear fit with 95% CI (grey shading). Subjects were consistently rewarded for approaching the blue object (dashed lines) or the green object (solid lines).", fig.id="colour-pref-training-plot",  warning=FALSE, message=FALSE}
###### Time with rewarding object plot during training ######
ggplot(
  training_data,
  aes(
    x = trial,
    y = green.object.preference,
    color = rewarding.object.colour,
    shape = rewarding.object.colour,
    linetype = rewarding.object.colour
  )
) +
  theme_minimal() +
  ylab("Green object preference (sec)") +
  xlab("Trial") +
  labs(col = "Rewarding object colour") +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c("#2980b9", "#27ae60")) +
  scale_linetype_manual(values = c("longdash", "solid")) +
  scale_shape_manual(values = c(15, 16)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_point(alpha = 0.3) +
  geom_line(aes(group = id), alpha = 0.2) +
  scale_x_continuous(breaks = c(1:20)) +
  scale_y_continuous(breaks = seq(-300, 300, by = 100)) +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.25) +
  stat_summary(fun = "mean", size = 0.8)

ggsave(
  filename = "exp-1-model-2-colour-pref-training-plot.png",
  path = "figs/exp-1/",
  device = "png",
  dpi = 300
)
```

***

### Model 3 -  Preference for the rewarded object during testing depending on treatment {#model-3}

For the main effects of training and rewarding object colour on rewarding object
preference I fit a generalized linear mixed effects model with a Gaussian
distribution which modeled the variances to account for variance heterogeneity
using the package
[`glmmTMB`](https://cran.r-project.org/web/packages/glmmTMB/index.html). Our
third model asks whether the preference for the rewarding object changed between
baseline and final test and looks for an interaction with rewarded object
colour. To control for heterogeneous variance across
trials we additionally modelled the variance due to trial across both colour
treatments.

```{r model-3, echo=TRUE}
test_data_model_glm <-  
  glmmTMB(rewarding.object.preference ~  
            trial * rewarding.object.colour + (1|id) + 
            diag(0 + rewarding.object.colour:trial |id), 
  data = test_data, 
  family = gaussian
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#BlockName3"> See Model 3 Residuals </button>  
<div id="BlockName3" class="collapse">  

```{r, include=TRUE,echo=FALSE, message=FALSE}
simulationOutput <- simulateResiduals(fittedModel = test_data_model_glm, n = 1000)
plot(simulationOutput)

# Saving plot to figs directory
ggsave(
  filename = "exp-1-model-3-residual-plot.png",
  plot = (plot(simulationOutput)),
  path = "figs/exp-1/residual-plots/",
  device = "png",
  dpi = 300
)
```

</div>

```{r tidying-model-3, echo=FALSE, message=FALSE}
# Setting table row names
test_model_table_row_name_vec <- c(
  "Intercept",
  "Trial",
  "Rewarding object colour",
  "Rewarding object colour X Trial"
)

# Converting data frame to tibble
tidy_test_data_model <- broom.mixed::tidy(test_data_model_glm)

# Formatting p value
tidy_test_data_model$p.value <- format_p_value(tidy_test_data_model$p.value)

# Changing tibble header names
tidy_test_data_model <- rename_tidy_lme4_cols(tidy_test_data_model)

# Changing tibble row names
tidy_test_data_model[1:4, 4] <- test_model_table_row_name_vec
```

</br>

##### Results

```{r model-3-table, results=TRUE, echo=FALSE}
knitr::kable(tidy_test_data_model[1:4, ] %>%
  dplyr::select(-group, -effect, -component) %>%
  mutate_if(is.numeric, round, digits = 3),
caption = "Summary table for Model 3. Estimates ± standard error (SE) of the 
effects of trial and rewarding object colour on the rewarding object preference 
from the generalized linear mixed effect model containing the effects Trial, 
Rewarding object colour, and their interaction effect (Trial X Rewarding object 
colour)."
)
```

When comparing the initial and final preference test, both conducted after
training and without food rewards present, we found a significant interaction
effect between test and rewarding object colour (p =
`r tidy_test_data_model$'P value'[4]`). Guppies that had been green-rewarded had
a shift in their rewarded object preference that was on average
`r report_est_and_std_error(tidy_test_data_model, rounding = 0)[4]` seconds
stronger than the shift in rewarded object preference of guppies trained to blue
(Figure \@ref(fig:test-data-pref-plot)).

```{r test-data-pref-plot, echo=FALSE, message=FALSE, fig.cap="Changes in object preference from an initial test before training to a final test after training. During training, fish were rewarded for approaching the blue object (blue squares and lines) or the green object (green squares and lines). At test, no food reward was present. Dashed line represents an equal preference for either object. Data are means ± 95% CI; lighter points and lines are data for each individual. The final preference for green-rewarded fish is stronger than that of fish that has been rewarded for approaching the blue object.", fig.id="test-data-pref-plot", warning=FALSE, message=FALSE}
###### Time with rewarding object plot during testing ######
testing_data_x_axis_labels <- c("Initial test", "Final test")
object_labels <- c("Blue-trained", "Green-trained")
names(object_labels) <- c("blue", "green")

ggplot(
  test_data,
  aes(
    x = trial,
    y = rewarding.object.preference,
    color = rewarding.object.colour,
    shape = rewarding.object.colour
  )
) +
  theme_minimal() +
  geom_jitter(width = 0, alpha = 0.3) +
  stat_summary(geom = "point", fun = "mean", size = 4.5) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_ci",
    position = position_dodge(width = 0),
    width = 0.1
  ) +
  ylab("Rewarding object preference (sec)") +
  xlab("Trial") +
  labs(col = "Rewarding object colour") +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5),
    strip.text.x = element_text(size = 14, face = "bold")
  ) +
  scale_color_manual(values = c("#2980b9", "#27ae60")) +
  scale_shape_manual(values = c(15, 16)) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.6) +
  geom_line(aes(group = id), alpha = 0.2) +
  scale_x_discrete(labels = testing_data_x_axis_labels) +
  facet_grid(~rewarding.object.colour,
    labeller = labeller(rewarding.object.colour = object_labels)
  ) +
  stat_summary(fun = mean, 
               geom = "line", 
               aes(group = rewarding.object.colour)) +
  scale_y_continuous(breaks = seq(-50, 200, by = 25))

ggsave(
  filename = "exp-1-model-3-test-data-pref-plot.png",
  path = "figs/exp-1/",
  device = "png",
  dpi = 300
)
```

</br>

#### Post-hoc Comparisons

To determine whether the means of the final rewarding object preference for the
two treatments were different I conducted post-hoc comparisons with the package
[`emmeans`](https://cran.r-project.org/package=emmeans). I compared the
following means:

  - Final test blue-trained and initial test blue-trained
  - Final test green-trained and initial test green-trained
  - Final test green-trained and final test blue-trained
  - Initial test green-trained and initial test blue-trained

```{r post-hoc-comparisons, echo=TRUE}
test_data_model_emmeans <- emmeans(test_data_model_glm,
  specs = ~ trial:rewarding.object.colour
)

# Making vectors to represent means of interest from emmeans() output
blue0 <- c(1, 0, 0, 0)
blue21 <- c(0, 1, 0, 0)
green0 <- c(0, 0, 1, 0)
green21 <- c(0, 0, 0, 1)

# Set seed to prevent confidence intervals from changing when code is re-run
set.seed(123)

custom_contrasts <- contrast(test_data_model_emmeans,
  method = list(
    "21 blue - 0 blue" = blue21 - blue0,
    "21 green - 0 green " = green21 - green0,
    "21 green - 21 blue" = green21 - blue21,
    "0 green - 0 blue" = green0 - blue0
  ), adjust = "mvt"
) %>%
  summary(infer = TRUE)
```

</br>

##### Results

```{r contrasts-table-formatting, echo=FALSE, fig.id="contrasts-table", warning=FALSE}
# Convert contrasts to data frame
pairwise_comparison_contrasts_table <- as.data.frame(custom_contrasts)

# Formatting p values
pairwise_comparison_contrasts_table$p.value <- format_p_value(pairwise_comparison_contrasts_table$p.value)
```

```{r contrasts-table-display, echo=FALSE}
knitr::kable(pairwise_comparison_contrasts_table %>%
  dplyr::select(contrast, estimate, lower.CL, upper.CL, df, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  rename(
    "Contrast" = contrast,
    "Estimate" = estimate,
    "Lower CL" = lower.CL,
    "Upper CL" = upper.CL,
    "P Value" = p.value
  ),
caption = "Table of post-hoc tests with a multivariate-t adjustment for multiple 
comparisons of a selected set of means. The numbers represent the initial test 
(0) and the final test (21). The colour corresponds to the identity of the 
rewarding object (blue for blue-rewarded guppies, green for green-rewarded 
guppies). Values are all rounded to 3 decimal places. CL = confidence limit."
)
```

Post-hoc comparisons (Table \@ref(tab:contrasts-table-display)) reveal that
initially, before training, there was no significant difference in the strength
of preference for the rewarded object between the treatments
(`r report_est_and_std_error(pairwise_comparison_contrasts_table, 0, F)[4]`
seconds, p = `r pairwise_comparison_contrasts_table$p.value[4]`). The shift in
rewarded object preference between the initial and final preference tests was
significant for green-trained guppies but not for blue-trained guppies: green
trained guppies increased their preference for the green object by
`r report_est_and_std_error(pairwise_comparison_contrasts_table, 0, F)[2]`
seconds, from initial to final (p
`r pairwise_comparison_contrasts_table$p.value[2]`) test whereas blue-trained
guppies increased their preference for the blue object by
`r report_est_and_std_error(pairwise_comparison_contrasts_table, 0, F)[1]`
seconds an effect that was not statistically significant (p =
`r pairwise_comparison_contrasts_table$p.value[1]`). At final test,
green-rewarded guppies had a significantly stronger preference for the
previously rewarded object compared to the blue-rewarded guppies (Difference in
preference:
`r report_est_and_std_error(pairwise_comparison_contrasts_table, 0, F)[3]`
seconds, p = `r pairwise_comparison_contrasts_table$p.value[3]`).

***

```{r feeding-data-prep, include = FALSE}
#### Get feeding data #####
# Group by ID and count the number of sessions in which an individual ate
feeding <- my_data %>%
  group_by(id) %>%
  count(feeding.count = ate == "yes")

# Remove NAs from this
feeding <- na.omit(feeding)

# Count only the yeses
feeding <- feeding %>%
  filter(feeding.count == "TRUE")

# Remove the column feeding.count to keep only the counts
feeding <- feeding %>%
  dplyr::select(-feeding.count)

# Add the feeding values to the main data frame so I can get treatment IDs
my_feeding_data <- left_join(baseline_data, feeding, by = "id")

# Replace NAs with 0, rename n to feeding count, and extract id, feeding count,
# and rewarding object colour treatment
my_feeding_data <- my_feeding_data %>%
  replace_na(list(n = 0)) %>%
  rename(feeding.count = n) %>%
  dplyr::select(id, feeding.count, rewarding.object.colour)
```

### Model 4 - Is there a difference in feeding attempts between treatments? {#model-4}

A discrepancy in reinforcement between treatments may influence performance on a
final preference test. To see whether there was a difference in feeding between
treatments I counted the number of trials in which an individual fish ate
throughout all of training and compared the feeding counts between treatments.
To do this I fit a generalized linear model with a negative binomial
distribution. The response variable 'feeding count' is a sum of the number of
trials in which a guppy ate.

##### Model

```{r model-4, echo=TRUE}
feeding_data_model <-
  glm.nb(feeding.count ~ rewarding.object.colour,
    data = my_feeding_data
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#BlockName4"> See Model 4 Residuals </button>  
<div id="BlockName4" class="collapse">  

```{r, echo=FALSE, message=FALSE}
simulationOutput <- simulateResiduals(fittedModel = feeding_data_model)
plot(simulationOutput)

# Saving plot to figs directory
ggsave(
  filename = "exp-1-model-4-residual-plot.png",
  plot = (plot(simulationOutput)),
  path = "figs/exp-1/residual-plots/",
  device = "png",
  dpi = 300
)
```

</div>

```{r tidying-model-4, echo=FALSE, message=FALSE}
# Setting table row names
feeding_model_table_row_name_vec <- c(
  "Intercept",
  "Rewarding object colour"
)

# Converting data frame to tibble
tidy_feeding_data_model <- broom.mixed::tidy(feeding_data_model)

# Getting model confidence intervals
feeding_data_model_confint <- tibble::as_tibble((feeding_data_model %>%
  confint()), rownames = "factor")

# Changing tibble header names
tidy_feeding_data_model <- rename_tidy_lme4_cols(tidy_feeding_data_model)

# Changing tibble row names
tidy_feeding_data_model[1:2, 1] <- feeding_model_table_row_name_vec
```

</br>

##### Results

```{r, results=TRUE, echo=FALSE}
knitr::kable(tidy_feeding_data_model[1:2, ] %>%
  mutate_if(is.numeric, round, digits = 3))
```

We found no significant difference in the number of trials individuals fed
between green-rewarded and blue-rewarded fish (Figure
\@ref(fig:feeding-count-plot), p =
`r tidy_feeding_data_model$'P value'[2] %>% round(3)`).
We also incorporated feeding count as a covariate in [Model 3](#model-3),
finding the same pattern of results (See [ESM Model 1](#esm-model-1)).

```{r feeding-count-plot, echo=FALSE, message=FALSE, fig.cap="Average number of trials in which a fish fed during training. Data are means ± 95% confidence intervals with probability density functions of the data to the right of the raw data.", fig.id="training-data-ate-plot", warning=FALSE}

ggplot(
  my_feeding_data,
  aes(
    x = rewarding.object.colour,
    y = feeding.count,
    fill = rewarding.object.colour,
    colour = rewarding.object.colour
  )
) +
  geom_point(position = position_jitter(width = 0.05), alpha = 0.8) +
  stat_summary(geom = "point", fun = "mean", size = 4.5, shape = 15) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_ci",
    position = position_dodge(width = 0),
    width = 0.1
  ) +
  ylim(-3, 23) +
  ylab("Rewarding object preference") +
  xlab("Trial") +
  theme_minimal() +
  guides(fill = "none", colour = "none") +
  ylab("Number of trials fed") +
  xlab("Rewarding object colour") +
  labs(col = "Rewarding object colour") +
  theme(
    legend.position = "top",
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5)
  ) +
  scale_color_manual(values = c("#2980b9", "#27ae60")) +
  scale_fill_manual(values = c("#2980b9", "#27ae60"))

# Saving plot
ggsave(
  filename = "exp-1-model-4-feeding-count-plot.png",
  path = "figs/exp-1/",
  device = "png",
  dpi = 300
)
```

***

## ESM Models

In this section we describe models not included in the main text.

### ESM Model 1 - Including feeding count as a covariate {#esm-model-1}

This model was run to address the potential role of feeding count on test
performance. The concern was that the results may be explained by differential
levels of reinforcement between the groups or between individuals during
training. To ensure our results were robust to matters arising from feeding
count variation we included feeding count as a co-variate and re-ran the
analysis in [Model 3](#model-3). With this model we looked to see whether
including the amount of trials an individual fed as a covariate in the model
changes the conclusions.

```{r, include=FALSE}
test_feeding_data <- left_join(test_data, feeding, by = "id")
test_feeding_data <- test_feeding_data %>% replace_na(list(n = 0))
test_feeding_data <- rename(test_feeding_data, feeding.count = n)
retest_feeding_data <- test_feeding_data %>% filter(trial == "21")
```

```{r, echo = TRUE}
test_data_feeding_controlled_model <-
  glmmTMB(rewarding.object.preference ~
  trial * rewarding.object.colour + feeding.count + (1 | id) +
    diag(0 + rewarding.object.colour * trial | id),
  data = test_feeding_data,
  family = gaussian
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#BlockName7"> See ESM Model 1 Residuals </button>  
<div id="BlockName7" class="collapse">  

```{r, echo=FALSE, message=FALSE}
simulationOutput <- simulateResiduals(fittedModel = test_data_feeding_controlled_model)
plot(simulationOutput)

# Saving plot to figs directory
ggsave(
  filename = "exp-1-ESM-model-1-residual-plot.png",
  plot = (plot(simulationOutput)),
  path = "figs/exp-1/residual-plots/",
  device = "png",
  dpi = 300
)
```

</div>

</br>
```{r, echo=FALSE, results=FALSE}
# Setting table row names
test_data_feeding_controlled_model_table_row_name_vec <- c(
  "Intercept",
  "Trial",
  "Rewarding object colour",
  "Feeding count",
  "Rewarding object colour X Trial"
)

tidy_fit_test_data_feeding_controlled_model <- broom.mixed::tidy(test_data_feeding_controlled_model)

# formatted p value
tidy_fit_test_data_feeding_controlled_model$p.value <- format_p_value(tidy_fit_test_data_feeding_controlled_model$p.value)

# Changing tibble header names
tidy_fit_test_data_feeding_controlled_model <- rename_tidy_lme4_cols(tidy_fit_test_data_feeding_controlled_model)

tidy_fit_test_data_feeding_controlled_model[1:5, 4] <- test_data_feeding_controlled_model_table_row_name_vec
```

##### Results

```{r feeding-controlled-table, results=TRUE, echo=FALSE}
knitr::kable(tidy_fit_test_data_feeding_controlled_model[1:5, ] %>%
  dplyr::select(-group, -effect, -component) %>%
  mutate_if(is.numeric, round, digits = 3),
caption = "Summary table for a modification of Model 3. This model is the same 
as that described in Table 1 except it includes feeding count as a covariate. 
Estimates ± standard error (SE) of the effects of trial and rewarding object 
colour of the rewarding object colour from the generalized linear mixed effect 
model containing the effects (Trial, Rewarding object colour, and their 
interaction effect)."
)
```

The main results do not change if we control for feeding count. Table
\@ref(tab:feeding-controlled-table) is the output for the feeding controlled
model. Below we have the output table for the non-feeding-count controlled model
from [Model 3](#model-3) (Table \@ref(tab:model-3-table)) reproduced. In both
models the statistical conclusions are the same.

```{r, results=TRUE, echo=FALSE}
knitr::kable(tidy_test_data_model[1:4, ] %>%
  dplyr::select(-group, -effect, -component) %>%
  mutate_if(is.numeric, round, digits = 3))
```

***

### ESM Model 2 - Percentage preference for the rewarded object during testing depending on treatment

A reviewer of our manuscript asks 

>Why the authors did not (also) exploit a percentage preference, which is commonly used?

To determine whether our results are robust despite our different
measure we also ran an analysis with the percentage preference as ESM Model 2. 
The results from the main experiment remain unchanged when we do this.

Since our data are continuous proportions we used a generalized linear mixed
effect model with a beta distribution.

```{r}
prop_test_data_model_glm <-  
  glmmTMB(prop.rewarding.object.preference ~  
            trial * rewarding.object.colour + (1|id), 
  data = test_data, 
  family = beta_family(link="logit")
  )
```

<button class="btn btn-primary" data-toggle="collapse" data-target="#BlockName8"> See ESM Model 2 Residuals </button>  
<div id="BlockName8" class="collapse"> 

```{r, message=FALSE}
simulationOutput <- simulateResiduals(
  fittedModel = prop_test_data_model_glm,
  n = 1000
)
plot(simulationOutput)
```

</div>

```{r, echo=FALSE, message=FALSE}
# Saving plot to figs directory
ggsave(
  filename = "exp-1-ESM-model-2-residual-plot.png",
  plot = (plot(simulationOutput)),
  path = "figs/exp-1/residual-plots/",
  device = "png",
  dpi = 300
)
```

```{r tidying-esm-model-3, echo=FALSE, message=FALSE}
# Setting table row names
test_model_table_row_name_vec <- c(
  "Intercept",
  "Trial",
  "Rewarding object colour",
  "Rewarding object colour X Trial"
)

# Converting data frame to tibble
tidy_prop_test_data_model <- broom.mixed::tidy(prop_test_data_model_glm)

# Formatting p value
tidy_prop_test_data_model$p.value <- format_p_value(tidy_prop_test_data_model$p.value)

# Changing tibble header names
tidy_prop_test_data_model <- rename_tidy_lme4_cols(tidy_prop_test_data_model)

# Changing tibble row names
tidy_prop_test_data_model[1:4, 4] <- test_model_table_row_name_vec
```

</br>

##### Results

```{r, results=TRUE, echo=FALSE}
knitr::kable(tidy_prop_test_data_model[1:4, ] %>%
  dplyr::select(-group, -effect, -component) %>%
  mutate_if(is.numeric, round, digits = 3),
caption = "Summary table for ESM Model 2. Estimates ± standard error (SE) of the 
effects of trial and rewarding object colour on the rewarding object preference 
from the generalized linear mixed effect model containing the effects Trial, 
Rewarding object colour, and their interaction effect (Trial X Rewarding object 
colour)."
)
```

As in [Model 3](#model-3) we find there is an interaction effect between
trial and rewarding object colour for the test trials (p =
`r tidy_prop_test_data_model$'P value'[4]`). We again conduct
post-hoc tests as described in the [Model 3](#model-3) section.

```{r prop-test-data-pref-plot, echo=FALSE, message=FALSE, fig.cap="Changes in proportional object preference from an initial test before training to a final test after training. During training, fish were rewarded for approaching the blue object (blue squares and lines) or the green object (green squares and lines). At test, no food reward was present. Dashed line represents an equal preference for either object. Data are means ± 95% CI; lighter points and lines are data for each individual. The final preference for green-rewarded fish is stronger than that of fish that has been rewarded for approaching the blue object.", fig.id="prop-test-data-pref-plot", warning=FALSE, message=FALSE}
###### Time with rewarding object plot during testing ######
testing_data_x_axis_labels <- c("Initial test", "Final test")
object_labels <- c("Blue-trained", "Green-trained")
names(object_labels) <- c("blue", "green")

ggplot(
  test_data,
  aes(
    x = trial,
    y = prop.rewarding.object.preference,
    color = rewarding.object.colour,
    shape = rewarding.object.colour
  )
) +
  theme_minimal() +
  geom_jitter(width = 0, alpha = 0.3) +
  stat_summary(geom = "point", fun = "mean", size = 4.5) +
  stat_summary(
    geom = "errorbar",
    fun.data = "mean_ci",
    position = position_dodge(width = 0),
    width = 0.1
  ) +
  ylab("Rewarding object preference") +
  xlab("Trial") +
  labs(col = "Rewarding object colour") +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5),
    strip.text.x = element_text(size = 14, face = "bold")
  ) +
  scale_color_manual(values = c("#2980b9", "#27ae60")) +
  scale_shape_manual(values = c(15, 16)) +
  geom_hline(yintercept = 0.5, linetype = "dashed", alpha = 0.6) +
  geom_line(aes(group = id), alpha = 0.2) +
  scale_x_discrete(labels = testing_data_x_axis_labels) +
  facet_grid(~rewarding.object.colour,
    labeller = labeller(rewarding.object.colour = object_labels)
  ) +
  stat_summary(fun = mean, geom = "line", aes(group = rewarding.object.colour)) +
  scale_y_continuous(breaks = seq(0.1, 0.9, by = 0.1))

ggsave(
  filename = "exp-1-ESM-model-3-prop-test-data-pref-plot.png",
  path = "figs/exp-1/",
  device = "png",
  dpi = 300
)
```

##### Post-Hoc Comparisons

```{r}
prop_test_data_model_emmeans <- emmeans(prop_test_data_model_glm,
  specs = ~ trial:rewarding.object.colour, type = "response"
)

# Set seed to prevent confidence intervals from changing when code is re-run
set.seed(123)

prop_custom_contrasts <- contrast(prop_test_data_model_emmeans,
  method = list(
    "21 blue - 0 blue" = blue21 - blue0,
    "21 green - 0 green " = green21 - green0,
    "21 green - 21 blue" = green21 - blue21,
    "0 green - 0 blue" = green0 - blue0
  ), adjust = "mvt"
) %>%
  summary(infer = TRUE)
```

```{r prop-contrasts-table-formatting, echo=FALSE, fig.id="prop-contrasts-table", warning=FALSE}
# Convert contrasts to data frame
prop_pairwise_comparison_contrasts_table <- as.data.frame(prop_custom_contrasts)

# Formatting p values
prop_pairwise_comparison_contrasts_table$p.value <- format_p_value(prop_pairwise_comparison_contrasts_table$p.value)
```

##### Results

```{r prop-contrasts-table-display, echo=FALSE}
knitr::kable(prop_pairwise_comparison_contrasts_table %>%
  dplyr::select(contrast, odds.ratio, lower.CL, upper.CL, df, p.value) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  rename(
    "Contrast" = contrast,
    "Odds ratio" = odds.ratio,
    "Lower CL" = lower.CL,
    "Upper CL" = upper.CL,
    "P Value" = p.value
  ),
caption = "Table of post-hoc tests with a multivariate-t adjustment for multiple 
comparisons of a selected set of means. The numbers represent the initial test 
(0) and the final test (21). The colour corresponds to the identity of the 
rewarding object (blue for blue-rewarded guppies, green for green-rewarded 
guppies). Values are all rounded to 3 decimal places. CL = confidence limit."
)
```

We find the same pattern of results as in [Model 3](#model-3). Green-trained
guppies significantly increase their preference for the green object by 23% (p =
`r prop_pairwise_comparison_contrasts_table$p.value[2]`) whereas blue-trained
guppies non-significantly increase their preference for the blue object by 6% (p
= `r prop_pairwise_comparison_contrasts_table$p.value[1]`. There is no
significant difference in preference for the rewarding object between the
treatments before training (p =
`r prop_pairwise_comparison_contrasts_table$p.value[4]`).

***

## Packages used

The analyses on this page were done with `r R.version.string` and with functions
from packages listed in Table \@ref(tab:r-packages). This page was written in
Rmarkdown and rendered with `knitr`. In Table \@ref(tab:r-packages) we provide a
list of packages used, their versions, and references. Note this list does not
include the dependencies of these packages, it includes only packages
explicitly loaded with a `library()` call. Installing these packages would
automatically install all their dependencies but to see the full list of
dependencies for all packages used as well as their versions please visit the
[How to Reproduce the
Results](https://github.com/wyatt-toure/guppy-colour-learning#how-to-reproduce-the-results)
section of the README.

```{r r-packages, echo=FALSE, warning=FALSE}
report(sessionInfo()) %>% 
  as.data.frame() %>% 
  kable(caption = "All packages used for this analysis. The dependencies for these packages as well as their versions can be found in the README file.")
```
